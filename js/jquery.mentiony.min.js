/*
 * Contentediable Mentiony jQuery plugin
 * Version 0.1.0
 * Written by: Luat Nguyen(luatnd) on 2016/05/27
 *
 * Transform textarea or input into contentediable with mention feature.
 *
 * License: MIT License - http://www.opensource.org/licenses/mit-license.php
 */

var tmpEle=null;!function($){var KEY={AT:64,BACKSPACE:8,DELETE:46,TAB:9,ESC:27,RETURN:13,LEFT:37,UP:38,RIGHT:39,DOWN:40,SPACE:32,HOME:36,END:35,COMMA:188,NUMPAD_ADD:107,NUMPAD_DECIMAL:110,NUMPAD_DIVIDE:111,NUMPAD_ENTER:108,NUMPAD_MULTIPLY:106,NUMPAD_SUBTRACT:109,PAGE_DOWN:34,PAGE_UP:33,PERIOD:190},ISANDROID=/android/i.test(navigator.userAgent);jQuery.fn.mentiony=function(e,t){"object"!=typeof e&&e||(t=e);var n=$.extend({},{debug:0,applyInitialSize:!0,globalTimeout:null,timeOut:400,triggerChar:"@",onDataRequest:function(e,t,n){},onKeyPress:function(e,t,n){t.trigger(e)},onKeyUp:function(e,t,n){t.trigger(e)},onBlur:function(e,t,n){t.trigger(e)},onPaste:function(e,t,n){t.trigger(e)},onInput:function(e,t){},popoverOffset:{x:-30,y:0},templates:{container:'<div id="mentiony-container-[ID]" class="mentiony-container"></div>',content:'<div id="mentiony-content-[ID]" class="mentiony-content" contenteditable="true"></div>',popover:'<div id="mentiony-popover-[ID]" class="mentiony-popover"></div>',list:'<ul id="mentiony-popover-[ID]" class="mentiony-list"></ul>',listItem:'<li class="mentiony-item" data-item-id=""><div class="row"><div class="col-xs-3 col-sm-3 col-md-3 col-lg-3"><img src="https://avatars2.githubusercontent.com/u/1859127?v=3&s=140"></div><div class="pl0 col-xs-9 col-sm-9 col-md-9 col-lg-9"><p class="title">Company name</p><p class="help-block">Addition information</p></div></div></li>',normalText:'<span class="normal-text">&nbsp;</span>',highlight:'<span class="highlight"></span>',highlightContent:'<a href="[HREF]" data-item-id="[ITEM_ID]" class="mentiony-link">[TEXT]</a>'}},t);return this.each(function(){var t=$.data(this,"mentiony")||$.data(this,"mentiony",new MentionsInput(n));return"function"==typeof t[e]?t[e].apply(this,Array.prototype.slice.call(outerArguments,1)):"object"!=typeof e&&e?void $.error("Method "+e+" does not exist"):t.init.call(this,this)})};var MentionsInput=function(settings){var elmInputBoxContainer,elmInputBoxContent,elmInputBox,elmInputBoxInitialWidth,elmInputBoxInitialHeight,editableContentLineHeightPx,popoverEle,list,elmInputBoxId,elmInputBoxContentAbsPosition={top:0,left:0},dropDownShowing=!1,events={keyDown:!1,keyPress:!1,input:!1,keyup:!1},currentMention={keyword:"",jqueryDomNode:null,mentionItemDataSet:[],lastActiveNode:0,charAtFound:!1},needMention=!1,inputId=Math.random().toString(36).substr(2,6),onDataRequestCompleteCallback=function(e){populateDropdown(currentMention.keyword,e)};function initTextArea(e){if("true"!=(elmInputBox=$(e)).attr("data-mentions-input")){elmInputBox.attr("data-mentions-input","true"),0==elmInputBox.attr("id").length?(elmInputBoxId="mentiony-input-"+inputId,elmInputBox.attr("id",elmInputBoxId)):elmInputBoxId=elmInputBox.attr("id"),elmInputBoxInitialWidth=elmInputBox.prop("scrollWidth"),elmInputBoxInitialHeight=elmInputBox.prop("scrollHeight"),elmInputBoxContainer=$(settings.templates.container.replace("[ID]",inputId)),elmInputBoxContent=$(settings.templates.content.replace("[ID]",inputId));var t=elmInputBox.attr("placeholder");void 0===t&&(t=elmInputBox.text()),elmInputBoxContent.attr("data-placeholder",t),elmInputBoxContainer.append(elmInputBox.clone().addClass("mention-input-hidden")),elmInputBoxContainer.append(elmInputBoxContent),elmInputBox.replaceWith(elmInputBoxContainer),popoverEle=$(settings.templates.popover.replace("[ID]",inputId)),list=$(settings.templates.list.replace("[ID]",inputId)),elmInputBoxContainer.append(popoverEle),popoverEle.append(list),elmInputBox=$("#"+elmInputBoxId);var n=parseInt(elmInputBoxContainer.css("padding"));settings.applyInitialSize?(elmInputBoxContainer.addClass("initial-size"),elmInputBoxContainer.css({width:elmInputBoxInitialWidth+"px"}),elmInputBoxContent.width(elmInputBoxInitialWidth-2*n+"px")):elmInputBoxContainer.addClass("auto-size"),elmInputBoxContent.css({minHeight:elmInputBoxInitialHeight+"px"}),elmInputBoxContentAbsPosition=elmInputBoxContent.offset(),editableContentLineHeightPx=parseInt($(elmInputBoxContent.css("line-height")).selector),elmInputBoxContent.bind("keydown",onInputBoxKeyDown),ISANDROID?elmInputBoxContent.bind("textInput",onInputBoxAndroidInput):elmInputBoxContent.bind("keypress",onInputBoxKeyPress),elmInputBoxContent.bind("input",onInputBoxInput),elmInputBoxContent.bind("keyup",onInputBoxKeyUp),elmInputBoxContent.bind("click",onInputBoxClick),elmInputBoxContent.bind("blur",onInputBoxBlur),elmInputBoxContent.bind("paste",onInputBoxPaste)}}function onInputBoxKeyDown(e){if(events={keyDown:!0,keyPress:!1,input:!1,keyup:!1},dropDownShowing)return handleUserChooseOption(e)}function onInputBoxAndroidInput(e){events.keyPress=!0,needMention||(needMention=e.originalEvent.data.charCodeAt(0)===KEY.AT)}function onInputBoxKeyPress(e){events.keyPress=!0,needMention||(needMention=e.keyCode===KEY.AT||e.which===KEY.AT),content.click(),settings.onKeyPress.call(this,e,elmInputBox,elmInputBoxContent)}function onInputBoxInput(e){events.input=!0;var t=e.originalEvent.data.charCodeAt(0);needMention||(needMention=e.keyCode===KEY.AT||e.which===KEY.AT||t===KEY.AT),content.click(),settings.onInput.call(this,elmInputBox,elmInputBoxContent)}function onInputBoxKeyUp(e){events.keyup=!0,events.input&&updateDataInputData(e),needMention&&(e.keyCode===KEY.RETURN&&e.which!==KEY.RETURN||!events.input&&e.keyCode!==KEY.LEFT&&e.which!==KEY.LEFT&&e.keyCode!==KEY.RIGHT&&e.which!==KEY.RIGHT||(updateMentionKeyword(e),doSearchAndShow())),settings.onKeyUp.call(this,e,elmInputBox,elmInputBoxContent)}function onInputBoxClick(e){needMention&&(updateMentionKeyword(e),doSearchAndShow())}function onInputBoxBlur(e){settings.onBlur.call(this,e,elmInputBox,elmInputBoxContent)}function onInputBoxPaste(e){settings.onPaste.call(this,e,elmInputBox,elmInputBoxContent)}function onListItemClick(e){setSelectedMention($(this)),choseMentionOptions(!0)}function updateDataInputData(e){var t=elmInputBoxContent.html();elmInputBox.val(convertSpace(t)),log(elmInputBox.val(),"elmInputBoxText : "),tmpEle=elmInputBox}function trimSpace(e){return e.replace(/^(&nbsp;|&nbsp|\s)+|(&nbsp;|&nbsp|\s)+$/g,"")}function convertSpace(e){return e.replace(/(&nbsp;)+/g," ")}function doSearchAndShow(){settings.timeOut>0?(null!==settings.globalTimeout&&clearTimeout(settings.globalTimeout),settings.globalTimeout=setTimeout(function(){settings.globalTimeout=null,settings.onDataRequest.call(this,"search",currentMention.keyword,onDataRequestCompleteCallback)},settings.timeOut)):settings.onDataRequest.call(this,"search",currentMention.keyword,onDataRequestCompleteCallback)}function populateDropdown(e,t){list.empty(),currentMention.jqueryDomNode=null,currentMention.mentionItemDataSet=t,t.length?(!0===currentMention.charAtFound&&showDropDown(),t.forEach(function(e,t){var n=$(settings.templates.listItem);n.attr("data-item-id",e.id),n.find("img:first").attr("src",e.avatar),n.find("p.title:first").html(e.name),n.find("p.help-block:first").html(e.info),n.bind("click",onListItemClick),list.append(n)})):hideDropDown()}function showDropDown(){var e=getSelectionCoords();dropDownShowing=!0,popoverEle.css({display:"block",top:e.y-(elmInputBoxContentAbsPosition.top-$(document).scrollTop())+(editableContentLineHeightPx+10),left:e.x-elmInputBoxContentAbsPosition.left})}function hideDropDown(){dropDownShowing=!1,popoverEle.css({display:"none"})}function handleUserChooseOption(e){return!dropDownShowing||(e.keyCode===KEY.UP||e.which===KEY.UP||e.keyCode===KEY.DOWN||e.which===KEY.DOWN?(choosingMentionOptions(e),!1):e.keyCode!==KEY.HOME&&e.which!==KEY.HOME&&e.keyCode!==KEY.RETURN&&e.which!==KEY.RETURN&&e.keyCode!==KEY.TAB&&e.which!==KEY.TAB||(choseMentionOptions(),!1))}function updateMentionKeyword(e){if(document.selection)var t=document.selection.createRange();else t=window.getSelection().anchorNode;var n=t.data;void 0===n&&(n="");var o=getSelectionEndPositionInCurrentLine();currentMention.lastActiveNode=t,currentMention.keyword="";for(var i=o-1,r=!0;r;){var l=n.charAt(i);""!==l&&l!==settings.triggerChar||(r=!1),i--}currentMention.keyword=n.substring(i+1,o),-1===currentMention.keyword.indexOf(settings.triggerChar)?(currentMention.keyword="",currentMention.charAtFound=!1,hideDropDown()):(currentMention.keyword=currentMention.keyword.substring(1,o),currentMention.charAtFound=!0),log(currentMention.keyword,"currentMention.keyword")}function getMentionKeyword(){return currentMention.keyword}function setSelectedMention(e){currentMention.jqueryDomNode=e,updateSelectedMentionUI(e),log(e,"setSelectedMention item: ")}function updateSelectedMentionUI(e){$.each(list.children(),function(e,t){$(t).removeClass("active")}),e.addClass("active")}function choosingMentionOptions(e){log("choosingMentionOptions"),null===currentMention.jqueryDomNode&&setSelectedMention(list.children().first());var t=[];e.keyCode===KEY.DOWN||e.which===KEY.DOWN?t=currentMention.jqueryDomNode.next():e.keyCode!==KEY.UP&&e.which!==KEY.UP||(t=currentMention.jqueryDomNode.prev()),0===t.length&&(t=currentMention.jqueryDomNode),setSelectedMention(t)}function choseMentionOptions(e){"undefined"===e&&(e=!1),log("choosedMentionOptions by "+(e?"Mouse":"Keyboard"));for(var t={},n=currentMention.jqueryDomNode.attr("data-item-id"),o=0,i=currentMention.mentionItemDataSet.length;o<i;o++)if(n==currentMention.mentionItemDataSet[o].id){t=currentMention.mentionItemDataSet[o];break}var r=$(settings.templates.highlight),l=$(settings.templates.highlightContent.replace("[HREF]",t.href).replace("[TEXT]",t.name).replace("[ITEM_ID]",t.id));r.append(l),replaceTextInRange("@"+currentMention.keyword,r.prop("outerHTML"),e),log("Finish mention","","warn"),needMention=!1,currentMention.keyword="",hideDropDown(),updateDataInputData()}function log(msg,prefix,level){void 0===level&&(level="log"),1===settings.debug&&eval("console."+level+"(inputId, prefix ? prefix + ':' : '', msg);")}function replaceTextInRange(e,t,n){var o,i={startBefore:0,startAfter:0,stopBefore:0,stopAfter:0},r=window.getSelection();if("undefined"!==n&&!0===n){var l=currentMention.lastActiveNode;try{var a=l.data.length}catch(e){log(e,"lastActiveNode Error:");a=0}(o=document.createRange()).setStart(l,a),o.collapse(!0),r.removeAllRanges(),r.addRange(o)}var s=r.focusOffset,p=s-e.length;window.getSelection?(!1,(r=window.getSelection()).rangeCount>0&&(o=r.getRangeAt(0).cloneRange()).collapse(!0)):(r=document.selection)&&"Control"!=r.type&&(o=r.createRange()),p!==s&&(o.setStart(r.anchorNode,p),o.setEnd(r.anchorNode,s),o.deleteContents());var u=document.createElement("span");u.setAttribute("class","mention-area"),u.innerHTML=t,o.insertNode(u),o.setEnd(r.focusNode,o.endContainer.length),i.startBefore=p,i.stopBefore=s,i.startAfter=p,i.stopAfter=p+u.innerText.length;var c=!1;for(u=$(r.anchorNode);!c;)0===u.next().text().length?c=!0:u=u.next();var d=$(settings.templates.normalText).insertAfter(u);return(o=document.createRange()).setStartAfter(d.get(0)),o.setEndAfter(d.get(0)),r.removeAllRanges(),r.addRange(o),i}return{init:function(e){initTextArea(e)}}};function getSelectionCoords(e){var t,n,o,i=(e=e||window).document,r=i.selection,l=0,a=0;if(r)"Control"!=r.type&&((t=r.createRange()).collapse(!0),l=t.boundingLeft,a=t.boundingTop);else if(e.getSelection&&(r=e.getSelection()).rangeCount&&((t=r.getRangeAt(0).cloneRange()).getClientRects&&(t.collapse(!0),(n=t.getClientRects()).length>0&&(o=n[0]),l=o.left,a=o.top),0==l&&0==a)){var s=i.createElement("span");if(s.getClientRects){s.appendChild(i.createTextNode("​")),t.insertNode(s),l=(o=s.getClientRects()[0]).left,a=o.top;var p=s.parentNode;p.removeChild(s),p.normalize()}}return{x:l,y:a}}function getSelectionEndPositionInCurrentLine(){var e=0;window.getSelection&&(e=window.getSelection().focusOffset);return e}}(jQuery);
